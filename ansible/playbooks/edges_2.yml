---
- name: Configure edges (APT from gateway repo, install docker.io, pull from registry, run Juice Shop)
  hosts: edges
  become: true

  vars:
    gateway_private_ip_val: "{{ gateway_private_ip }}"
    ubuntu_codename: "jammy"

    registry_port_int: "{{ registry_port | int }}"
    edge_app_port_int: "{{ edge_app_port | int }}"
    image_local: "{{ gateway_private_ip_val }}:{{ registry_port_int }}/juice-shop:latest"

  tasks:
    # -------------------------
    # APT from gateway private repo
    # -------------------------
    - name: Wait for gateway repo HTTP port
      ansible.builtin.wait_for:
        host: "{{ gateway_private_ip_val }}"
        port: 80
        timeout: 30

    - name: Backup existing sources.list (if any)
      ansible.builtin.copy:
        src: /etc/apt/sources.list
        dest: /etc/apt/sources.list.bak
        remote_src: true
      ignore_errors: true

    - name: Point APT sources to gateway private repo (no DNS needed)
      ansible.builtin.copy:
        dest: /etc/apt/sources.list
        mode: "0644"
        content: |
          deb http://{{ gateway_private_ip_val }}/ubuntu {{ ubuntu_codename }} main restricted universe multiverse
          deb http://{{ gateway_private_ip_val }}/ubuntu {{ ubuntu_codename }}-updates main restricted universe multiverse
          deb http://{{ gateway_private_ip_val }}/ubuntu {{ ubuntu_codename }}-security main restricted universe multiverse

    - name: Apt update (from gateway repo)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    # -------------------------
    # Docker + pull from private registry + run app
    # -------------------------
    - name: Install Docker from Ubuntu repo (docker.io) + prerequisites
      ansible.builtin.apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - docker.io
        state: present

    - name: Ensure docker running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true

    - name: Configure Docker to allow private registry (HTTP insecure)
      ansible.builtin.copy:
        dest: /etc/docker/daemon.json
        mode: "0644"
        content: |
          {
            "insecure-registries": ["{{ gateway_private_ip_val }}:{{ registry_port_int }}"]
          }
      notify: Restart docker

    - name: Apply docker daemon changes now
      ansible.builtin.meta: flush_handlers

    - name: Wait for gateway registry port
      ansible.builtin.wait_for:
        host: "{{ gateway_private_ip_val }}"
        port: "{{ registry_port_int }}"
        timeout: 30

    - name: Check registry v2 endpoint (debug)
      ansible.builtin.uri:
        url: "http://{{ gateway_private_ip_val }}:{{ registry_port_int }}/v2/"
        status_code: [200, 401]
      changed_when: false

    - name: Pull image from gateway registry
      ansible.builtin.command: docker pull {{ image_local }}
      register: pull_result
      changed_when: >
        ('Downloaded newer image' in pull_result.stdout) or
        ('Downloaded newer image' in pull_result.stderr) or
        ('Status: Downloaded newer image' in pull_result.stdout) or
        ('Status: Downloaded newer image' in pull_result.stderr)

    - name: Remove old container if exists
      ansible.builtin.shell: |
        set -e
        if docker ps -a --format '{{"{{"}}.Names{{"}}"}}' | grep -qx juice-shop; then
          docker rm -f juice-shop
        fi
      args:
        executable: /bin/bash

    - name: Run Juice Shop on edge port {{ edge_app_port_int }} -> container 3000
      ansible.builtin.command: >
        docker run -d --name juice-shop
        -p {{ edge_app_port_int }}:3000
        --restart unless-stopped
        {{ image_local }}
      changed_when: true

    - name: Wait for app port on edge
      ansible.builtin.wait_for:
        host: 127.0.0.1
        port: "{{ edge_app_port_int }}"
        delay: 2
        timeout: 120

  handlers:
    - name: Restart docker
      ansible.builtin.service:
        name: docker
        state: restarted
